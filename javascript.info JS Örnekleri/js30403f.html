<!DOCTYPE html>
<html>
<head>
    <meta charset="iso-8859-9 Türkçe" />
    <title>js30403f.html: Mozilla MDN ile "input-File" dosya seçen indexedDB örneði.</title>
    <style>
        body {background-color:Olive; color: DarkRed; font-size:20px; margin:1em;}
        input {background-color:Navy; color:orange;}
        button {background-color: MidnightBlue; color: Gold; font-size:15px;}
        #göster {color:Yellow; font-size:18px;}

        body {
            font-size: 0.8em;
            font-family: Sans-Serif;}
        form {
            background-color: DarkKhaki;
            border-radius: 0.3em;
            display: inline-block;
            padding: 1em;
            margin-bottom: 0.5em;}
        table {border-collapse: collapse;}
        input {
            padding: 0.3em;
            border-color: #ccc;
            border-radius: 0.3em;}
        .gerekli:after {
            content: "*";
            color: red;}
        .düðme-panosu {margin-top: 1em;}
        #dosya-gösterici {
            float: right;
            width: 48%;
            height: 20em;
            border: solid #d092ff 0.1em;
            margin-bottom:1em;
            background-color:SlateGray;}
        #dosya-gösterici iframe {
            width: 100%;
            height: 100%;}
        #kitap-listesi {
            width: 42%;
            background-color: #bbb;
            border-radius: 0.3em;}
        #kitap-listesi li {
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            padding-right: 0.5em;}
        #mesaj {margin-bottom: 1em;}
        .kaydetme-baþarýlý {
            padding: 0.5em;
            color: #00d21e;
            background-color: Yellow;
            border-radius: 0.2em;}
        .kaydetme-baþarýsýz {
            padding: 0.5em;
            color: #ff1408;
            background-color: Yellow;
            border-radius: 0.2em;}
        .not {font-size: smaller;}
        .imhacý {
            background-color: orange;
            color:Brown;}
        .imhacý:hover {
            background-color: #ff8000;
            color:DarkRed;}
        .imhacý:active {background-color: red;}
    </style>
</head>
<body>
    <input type="button" value="reload() ile Yenile" onClick="window.location.reload();"><br/>
    <input type="button" value="Veri tabanýný SÝL" onClick="fonk2()">
    <h4>indexedDB</h4>

    <script src="js30403f.js"></script>    

    <h1>IndexedDB Gösterisi: damla yükleme, ekitap kaydetme</h1>
    <div class="not">
        <p>Þu tarayýcýlarla test edilmiþtir:</p>
        <div id="uyumlu"></div>
    </div>

    <div id="mesaj"></div>

    <form id="kaydetme-formu">
        <table>
            <tbody>
                <tr>
                    <td><label for="kitap-baþlýðý" class="gerekli">Kitap baþlýðý:</label></td>
                    <td><input type="text" id="kitap-baþlýðý" name="kitap-baþlýðý" /></td>
                </tr>
                <tr>
                    <td><label for="kaynakça-no" class="gerekli">Kaynakça no:<br/><span class="not">(ISBN, ISSN, vb.)</span></label></td>
                    <td><input type="text" id="kaynakça-no" name="kaynakça-no"/></td>
                </tr>
                <tr>
                    <td><label for="yayýn-yýlý">Yayýn yýlý:</label></td>
                    <td><input type="number" id="yayýn-yýlý" name="yayýn-yýlý" /></td>
                </tr>
            </tbody>
            <tbody>
                <tr>
                    <td><label for="kayýt-dosyasý">Kayýt dosyasý:</label></td>
                    <td><input type="file" id="kayýt-dosyasý"/></td>
                </tr>
                <tr>
                    <td><label for="yurel-kayýt-dosyasý">Çevrimiçi URL kayýt dosyasý:<br/><span class="not">(orijinal URL dosyasý)</span></label></td>
                    <td><input type="text" id="yurel-kayýt-dosyasý" name="yurel-kayýt-dosyasý"/></td>
                </tr>
            </tbody>
        </table>
        <div class="düðme-panosu">
            <input type="button" id="ekle-düðmesi" value="Kitap kaydýný ekle" />
            <!--"Kaydý deðiþtir" yerine deðiþtirilecek kaydý sil ve yenisini ekle-->
            <input type="reset" id="kaydetme-formunu-sýfýrla"/>
        </div>
    </form>

    <form id="silme-formu">
        <table>
            <tbody>
                <tr>
                    <td><label for="silinecek-kaynakça-no">Kaynakça no:<br/><span class="not">(ISBN, ISSN, vb.)</span></label></td>
                    <td><input type="text" id="silinecek-kaynakça-no" name="silinecek-kaynakça-no" /></td>
                </tr>
                <tr>
                    <td><label for="silinecek-anahtar">Anahtar:<br/><span class="not">(örneðin 1, 2, 3, vb.)</span></label></td>
                    <td><input type="text" id="silinecek-anahtar" name="silinecek-anahtar" /></td>
                </tr>
            </tbody>
        </table>
        <div class="düðme-panosu">
            <input type="button" id="sil-düðmesi" value="Kitap kaydýný sil" />
            <input type="button" id="depoyu-temizle-düðmesi" value="Tüm depoyu temizle" class="imhacý" />
        </div>
    </form>

    <form id="listeleme-formu">
        <div class="düðme-panosu">
            <input type="button" id="tümünü-göster-düðmesi" value="Depodaki tüm kayýtlarý göster" />
        </div>
    </form>

    <div>
        <div id="kitap-mesajý"></div>
        <div id="dosya-gösterici"></div>
        <ul id="kitap-listesi"></ul>
    </div>

    <script>
        (function () {// window.onload = function() {
            var UYUMLU_TARAYICILAR = [
                    ['Firefox', ">= 16.0"],
                    ['Google Chrome', ">= 24.0 (Google Chrome Canary gerekebilir), Damla depolama desteksiz"]
            ]; // var sonu...
            var uyumlu = $ ('#uyumlu');
            uyumlu.empty();
            uyumlu.append ('<ul id="uyumlu-liste"></ul>');
            UYUMLU_TARAYICILAR.forEach (function (deðer, endeks, dizi) {$ ('#uyumlu-liste').append ('<li>' + deðer [0] + ': ' + deðer [1] + '</li>'); });
            const VT_ADI = 'mdn-demo-indexedDB-kitaplar';
            const VT_SÜRÜMÜ = 1;
            const VT_DEPO_ADI = 'kitaplar';
            var vt;
            var aktüel_kitap_anahtarý;

            function açVT() {
                console.log ("açVT()...");
                var talep = indexedDB.open (VT_ADI, VT_SÜRÜMÜ);

                talep.onsuccess = function (olay) {
                    vt = this.result; // "vt = talep.result", veya "vt=olay.target.result" ile ayný...
                    console.log ("açVT() BAÞARILI");
                }; // tal.. sonu...

                talep.onerror = function (olay) {console.error ("açVT() HATA:", olay.target.errorCode); };

                talep.onupgradeneeded = function (olay) {
                    console.log ("açVT().onupgradeneeded");
                    var depo = olay.currentTarget.result.createObjectStore (VT_DEPO_ADI, {keyPath: 'kn', autoIncrement: true }); // kn:kimlik no=id...
                    depo.createIndex ('kaynakçakn', 'kaynakçakn', {unique: true}); // kaynakça kimlik no...
                    depo.createIndex ('baþlýk', 'baþlýk', {unique: false});
                    depo.createIndex ('yýl', 'yýl', {unique: false});
                }; // tal.. sonu...
            } // func sonu...

            function nesneDeposunuAl (depo_adý, kipi) {
                var iþlem = vt.transaction (depo_adý, kipi);
                return iþlem.objectStore (depo_adý);
            } // func sonu...

            function damlayýAl (anahtar, depo, baþarýlý_geridönüþ) {
                var talep = depo.get (anahtar);
                talep.onsuccess = function (olay) {
                    var deðer = olay.target.result;
                    if (deðer) baþarýlý_geridönüþ (deðer.damla);
                }; // tal.. sonu...
            } // func sonu...

            function yeniGörüntüÇerçevesi() {
                var gösterici = $ ('#dosya-gösterici');
                gösterici.empty();
                var çerçeve = $ ('<iframe />');
                gösterici.append (çerçeve);
                return çerçeve;
            } // func sonu...

            function görüntüyüKur (anahtar) {
                console.log ("görüntüyüKur(..) argümanlarý:", arguments);
                anahtar = Number (anahtar);
                if (anahtar == aktüel_kitap_anahtarý) return;
                aktüel_kitap_anahtarý = anahtar;
                var depo = nesneDeposunuAl (VT_DEPO_ADI, 'readonly');
                damlayýAl (anahtar, depo, function (damla) {
                    console.log ("görüntüyüKur(..) damla:", damla);
                    var çerçeve = yeniGörüntüÇerçevesi();
                    if (damla.type == 'text/html') {// metin ve html dosyalarýný göstermeliydi...
                        var okuyucu = new FileReader();
                        okuyucu.onload = function (olay) {
                            var html = olay.target.result;
                            çerçeve.load (function() {$(this).contents().find ('html').html (html); });
                        }; // oku.. sonu...
                        okuyucu.readAsText (damla);
                    }else if (damla.type.indexOf ('image/') == 0) { // Resmi de pdf gibi görüntülrmeliydi...
                        çerçeve.load (function() {
                            var resim_kn = 'image-' + anahtar;
                            var resim = $ ('<img kn="' + resim_kn + '"/>');
                            $ (this).contents().find ('body').html (resim);
                            var yurel_nesnesi = window.URL.createObjectURL (damla);
                            $ (this).contents().find ('#' + resim_kn).attr ('src', yurel_nesnesi);
                            window.URL.revokeObjectURL (yurel_nesnesi);
                        }); // çer.. sonu...
                    }else if (damla.type == 'application/pdf') {// Sadece pdf'yi gösteriyor...
                        $ ('*').css ('imleç', 'wait');
                        var yurel_nesnesi = window.URL.createObjectURL (damla);
                        çerçeve.load (function() {$ ('*').css ('imleç', 'auto'); });
                        çerçeve.attr ('src', yurel_nesnesi);
                        window.URL.revokeObjectURL (yurel_nesnesi);
                    }else {// Hiçbiri deðilse bu mesajý yansýtmalýydý...
                        çerçeve.load (function() {$ (this).contents().find ('body').html ("Gösterecek birþey yok"); });
                    } // else sonu...
                }); // dam.. sonu...
            } // func sonu...

            function tümünüGöster (depo) {
                console.log ("tümünüGöster(..)...");
                if (typeof depo == 'undefined') depo = nesneDeposunuAl (VT_DEPO_ADI, 'readonly');
                var kayýtSayýsý_mesajý = $ ('#kitap-mesajý');
                kayýtSayýsý_mesajý.empty();
                var kitapKayýtlarý_listesi = $ ('#kitap-listesi');
                kitapKayýtlarý_listesi.empty();
                yeniGörüntüÇerçevesi(); // Görüntülenen dosya varsa,pencere silinir...
                var talep;
                talep = depo.count();
                talep.onsuccess = function (olay) {kayýtSayýsý_mesajý.append ('<p>Nesne deposunda toplam <strong>' + olay.target.result + '</strong> adet kitap kaydý mevcuttur.</p>'); };
                talep.onerror = function (olay) {
                    console.error ("Kitap sayacý HATASI:", this.error);
                    kaydetmeBaþarýsýzlýðý (this.error);
                }; // tal.. sonu...
                var i = 0;
                talep = depo.openCursor();
                talep.onsuccess = function (olay) {
                    var imleç = olay.target.result;
                    if (imleç) {
                        console.log ("tümünüGöster(..) imleçi:", imleç);
                        talep = depo.get (imleç.key);
                        talep.onsuccess = function (olay) {
                            var deðer = olay.target.result;
                            var liste_birimi = $('<li>' +'[' + imleç.key + '] ' + '(kaynakçakn: ' + deðer.kaynakçakn + ') ' + deðer.baþlýk + '</li>');
                            if (deðer.yýl != null) liste_birimi.append (' - ' + deðer.yýl);
                            if (deðer.hasOwnProperty ('damla') && typeof deðer.damla != 'undefined') {
                                var baðlantý = $ ('<a href="' + imleç.key + '">Dosya</a>');
                                baðlantý.on ('click', function() {return false;}); // Týklanmaya deðil üzerindeye duyarlý...
                                baðlantý.on ('mouseover', function (olay) {görüntüyüKur (olay.target.getAttribute ('href')); });
                                liste_birimi.append (' / ');
                                liste_birimi.append (baðlantý);
                            }else {liste_birimi.append (" / Ekli dosya yok"); }
                            kitapKayýtlarý_listesi.append (liste_birimi);
                        }; // iç-tal sonu...
                        imleç.continue(); // bir sonraki kayda geç...
                        i++; // Haybeye...
                    }else {console.log ("Baþka kayýt kalmadý"); }
                }; // dýþ-tal sonu...
            } // func sonu...

            function yurelliKaydýEkle (kaynakçakn, baþlýk, yýl, yurel) {
                console.log ("yurelliKaydýEkle(..) argümanlarý:", arguments);
                var xhr = new XMLHttpRequest(); // xhr: XmlHttpRequest...
                xhr.open ('GET', yurel, true);
                xhr.responseType = 'blob';
                xhr.onload = function (olay) {
                    if (xhr.status == 200) {
                        console.log ("Blob damla dosyasý alýndý");
                        var damla = xhr.response;
                        console.log ("Blob damlasý:", damla);
                        kaydýEkle (kaynakçakn, baþlýk, yýl, damla);
                    }else {console.error ("yurelliKaydýEkle(..) HATASI:", xhr.responseText, xhr.status); }
                }; // xhr sonu...
                xhr.send();
            } // func sonu...

            function kaydýEkle (kaynakçakn, baþlýk, yýl, damla) {
                console.log ("kaydýEkle(..) argümanlarý:", arguments);
                var kayýtNesnesi = {kaynakçakn: kaynakçakn, baþlýk: baþlýk, yýl: yýl};
                if (typeof damla != 'undefined') kayýtNesnesi.damla = damla;
                var depo = nesneDeposunuAl (VT_DEPO_ADI, 'readwrite');
                var talep;
                try {talep = depo.add (kayýtNesnesi);
                }catch (olay) {
                    if (olay.name == 'DataCloneError') kaydetmeBaþarýsýzlýðý ("Bu motor bir Blob damlanýn nasýl klonlanacaðýný bilmiyor, " + "Firefox'u kullan");
                    throw olay;
                } // catch sonu...
                talep.onsuccess = function (olay) {
                    console.log ("VT içine sokulma baþarýlýdýr");
                    kaydetmeBaþarýsý();
                    tümünüGöster (depo);
                }; // tal.. sonu...
                talep.onerror = function() {
                    console.error ("kaydýEkle(..) HATA:", this.error);
                    kaydetmeBaþarýsýzlýðý (this.error);
                }; // tal.. sonu...
            } // func sonu...

            function nesneDeposunuTemizle() {
                var cevap = prompt ("Nesne deponuz, içerdiði tüm kayýtlarla silinecek.\nEmin misin [e/h]: ", "h");
                if (cevap.toLowerCase() != "e") return;
                var depo = nesneDeposunuAl (VT_DEPO_ADI, 'readwrite');
                var talep = depo.clear();
                talep.onsuccess = function (olay) {
                    kaydetmeBaþarýsý ("Kitap deposu temizlendi");
                    tümünüGöster (depo);
                }; // tal.. sonu...
                talep.onerror = function (olay) {
                    console.error ("nesneDeposunuTemizle() HATASI:", olay.target.errorCode);
                    kaydetmeBaþarýsýzlýðý (this.error); // olay.target.error...
                }; // tal.. sonu...
            } // func sonu...

            function kaynakçalýKaydýSil (kaynakçakn) {
                console.log ("kaynakçalýKaydýSil(..) argümanlarý:", arguments);
                var depo = nesneDeposunuAl (VT_DEPO_ADI, 'readwrite');
                var talep = depo.index ('kaynakçakn');
                talep.get (kaynakçakn).onsuccess = function (olay) {
                    if (typeof olay.target.result == 'undefined') {
                        kaydetmeBaþarýsýzlýðý ("Bu kaynakça numaralý kitap kaydý mevcut deðil");
                        return;
                    } // if sonu...
                    kaydýSil (olay.target.result.kn, depo);
                }; // tal.. sonu...
                talep.onerror = function (olay) {console.error ("kaynakçalýKaydýSil(..) HATASI:", olay.target.errorCode); };
            } // func sonu...

            function kaydýSil (anahtar, depo) {
                console.log ("kaydýSil(..) argümanlarý:", arguments);
                if (typeof depo == 'undefined') depo = nesneDeposunuAl (VT_DEPO_ADI, 'readwrite');
                var talep = depo.get (anahtar);
                talep.onsuccess = function (olay) {
                    var kayýt = olay.target.result;
                    console.log ("Silinecek kayýt:", kayýt);
                    if (typeof kayýt == 'undefined') {
                        kaydetmeBaþarýsýzlýðý ("Bu anahtar numaralý kitap kaydý mevcut deðil");
                        return;
                    } // if sonu...
                    talep = depo.delete (anahtar);
                    talep.onsuccess = function (olay) {
                        console.log ("olay:", olay);
                        console.log ("olay.target:", olay.target);
                        console.log ("olay.target.result:", olay.target.result);
                        console.log ("delete successful");
                        kaydetmeBaþarýsý("kaydýSil(..): Silme baþarýlý");
                        tümünüGöster (depo);
                    }; // iç-tal.. sonu...
                    talep.onerror = function (olay) {console.error ("kaydýSil(..) HATASI:", olay.target.errorCode); };
                }; // dýþ-tal.. sonu...
                talep.onerror = function (olay) {console.error ("kaydýSil(..) get(..) HATASI:", olay.target.errorCode); };
            } // func sonu...

            function kaydetmeBaþarýsý (mesaj) {
                mesaj = (typeof mesaj != 'undefined' ? "Baþarýlý: " + mesaj : "Baþarýlý");
                $ ('#mesaj').html ('<span class="kaydetme-baþarýlý">' + mesaj + '</span>');
            } // func sonu...

            function kaydetmeBaþarýsýzlýðý (mesaj) {
                mesaj = (typeof mesaj != 'undefined' ? "Baþarýsýz: " + mesaj : "Baþarýsýz");
                $ ('#mesaj').html ('<span class="kaydetme-baþarýsýz">' + mesaj + '</span>');
            } // func sonu...

            function kayýtFormunuSýfýrla() {
                console.log ("kayýtFormunuSýfýrla()...");
                $ ('#mesaj').empty();
                console.log ("kayýtFormunuSýfýrla() TAMAMLANDI");
            } // func sonu...

            function ekleOlayDinleyicileri() {
                console.log ("ekleOlayDinleyicileri()...");

                $ ('#kaydetme-formunu-sýfýrla').click (function (olay) {kayýtFormunuSýfýrla(); });

                $ ('#ekle-düðmesi').click (function (olay) {
                    console.log ("$-ekle...");
                    var baþlýk = $ ('#kitap-baþlýðý').val();
                    var kaynakçakn = $ ('#kaynakça-no').val();
                    if (! baþlýk || ! kaynakçakn) {
                        kaydetmeBaþarýsýzlýðý ("Gereken alan(lar) eksik");
                        return;
                    } // if sonu...
                    var yýl = $ ('#yayýn-yýlý').val();
                    if (yýl != '') {
                        if (isNaN (yýl))  {
                            kaydetmeBaþarýsýzlýðý ("Geçersiz yýl");
                            return;
                        } // iç-if sonu...
                        yýl = Number (yýl);
                    }else {yýl = null;}
                    var kaydýn_dosyasý = $ ('#kayýt-dosyasý');
                    var seçilen_dosya = kaydýn_dosyasý.get (0).files [0];
                    console.log ("Seçilen dosya:", seçilen_dosya);
                    var kaydýn_yureli = $ ('#yurel-kayýt-dosyasý').val();
                    if (seçilen_dosya) {kaydýEkle (kaynakçakn, baþlýk, yýl, seçilen_dosya);
                    }else if (kaydýn_yureli) {yurelliKaydýEkle (kaynakçakn, baþlýk, yýl, kaydýn_yureli);
                    }else {kaydýEkle (kaynakçakn, baþlýk, yýl);}
                }); // $-ekle sonu...

                $ ('#sil-düðmesi').click (function (olay) {
                    console.log ("$-sil...");
                    var kaynakçakn = $ ('#silinecek-kaynakça-no').val();
                    var anahtar = $ ('#silinecek-anahtar').val();
                    if (kaynakçakn != '') {kaynakçalýKaydýSil (kaynakçakn);
                    }else if (anahtar == "") {console.log ("kaydýSil(..) anahtar numarasý YOK!.."); return;}
                        else {if (isNaN (anahtar)) {
                            kaydetmeBaþarýsýzlýðý ("Geçersiz anahtar");
                            return;
                        } // iç-if sonu...
                        anahtar = Number (anahtar);
                        kaydýSil (anahtar);
                    } // else sonu...
                }); // $-sil sonu...

                $ ('#depoyu-temizle-düðmesi').click (function (olay) {nesneDeposunuTemizle(); });

                var döküm_düðmesi = $ ('#tümünü-göster-düðmesi');
                döküm_düðmesi.click (function (olay) {tümünüGöster(); });
            } // func sonu...

            açVT();
            ekleOlayDinleyicileri();
        })(); // DerhalYürütülenFonksiyonÝfadesi(DYFÝ)=Immediately-Invoked Function Expression (IIFE)

        function fonk2() {
            let ad = prompt ("Silinecek veri tabaný adýný girin:", "mdn-demo-indexedDB-kitaplar");
            let cevap = prompt ("Tüm veri tabanýnýz, içerdiði depolar ve kayýtlarla silinecek.\nEmin misin [e/h]: ", "h");
            if (cevap.toLowerCase() != "e") return;
            vt.close();
            let talep = indexedDB.deleteDatabase (ad);
            talep.onerror = function() {console.error ("HATA: " + talep.error); };
            talep.onsuccess = function() {console.log ("Veritabaný silinmiþtir"); };
        } // func sonu...
    </script>
</body>
</html>