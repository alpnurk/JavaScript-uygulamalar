<!DOCTYPE html>
<html>
<head>
    <meta charset="iso-8859-9 Türkçe" />
    <title>js30403e.html: Rush stüdyo albümleri 74-85, olay-temelli ve imleç taramalý indexedDB örneði.</title>
    <style>
        body {background-color:OliveDrab; color: SkyBlue; font-size:20px; margin:3em;}
        input {background-color:Navy; color:orange;}
        button {background-color: MidnightBlue; color: Gold; font-size:15px;}

        html {font-family: sans-serif;
            font-size: 10px;
            background-color:DarkGreen;}
        body {max-width: 800px;
            padding: 10px;
            background: linear-gradient(to bottom, rgba(150,150,255,0.8), rgba(255,150,100,0.6));}
        h1 {text-align: center;
            font-size: 2.5rem;
            text-shadow: 2px 2px 5px rgb(0,0,0);}
        ul {text-align: center;
            list-style-type: none;}
        li {font-size: 2rem;
            padding-bottom: 1rem;
            color: rgb(150, 100, 0, 0.85);}
        li strong {color: DarkRed;}
    </style>
</head>
<body>
    <input type="button" value="reload() ile Yenile" onClick="window.location.reload();"><br/>
    <h4 style="text-decoration: underline overline;">indexedDB</h4>

    <h1>Temel indexedDB openCursor örneði<br/>Rush stüdyo albümleri 74-85</h1>

    <ul></ul>

    <!-- Doðrudan onclick yerine class tanýmlý  query deðiþkene onclick fonksiyonlar sonradan atanmaktadýr -->
    <button class="hepsiniGöster">Tüm albümleri görelim</button>
    <button class="atlayarakGör">Birer atlayarak görelim</button>
    <button class="tekKaydýSil">Grace'i listelemizden silelim</button>
    <button class="tekKaydýDeðiþtir">'A farewell..'in yýlýný öteleyelim</button>
    <button class="terstenSýrala">Albümleri tepetakla yapalým</button>

    <script>
        let vt;
        let kayýtlar = [ // keyPath: 'albümBaþlýðý'na göre artan sýralar...
            {albümBaþlýðý: 'Power windows', yýl: 1985},
            {albümBaþlýðý: 'Grace under pressure', yýl: 1984},
            {albümBaþlýðý: 'Signals', yýl: 1982},
            {albümBaþlýðý: 'Moving pictures', yýl: 1981},
            {albümBaþlýðý: 'Permanent waves', yýl: 1980},
            {albümBaþlýðý: 'Hemispheres', yýl: 1978},
            {albümBaþlýðý: 'A farewell to kings', yýl: 1977},
            {albümBaþlýðý: '2112', yýl: 1976},
            {albümBaþlýðý: 'Caress of steel', yýl: 1975},
            {albümBaþlýðý: 'Fly by night', yýl: 1975},
            {albümBaþlýðý: 'Rush', yýl: 1974}
        ]; // kay.. sonu...
        let listele = document.querySelector ('ul'); // button class'lar deðiþkenlere atanýyor...
        let hepsiniGör = document.querySelector ('.hepsiniGöster');
        let atlayarakGör = document.querySelector ('.atlayarakGör');
        let kayýtSil = document.querySelector ('.tekKaydýSil');
        let tekKaydýDeðiþtir = document.querySelector ('.tekKaydýDeðiþtir');
        let tersSýrala = document.querySelector ('.terstenSýrala');

        window.onload = function() {// Tüm programý bu blokta tamamla...
            window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
            window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

            let vtAçmaTalebi = window.indexedDB.open ('albümlerVeritabaný', 1);
            vtAçmaTalebi.onsuccess = function (olay) {
                vt = vtAçmaTalebi.result; // veya 'olay.target.result'
                kayýtlarýEkle();
            }; // vtA.. sonu...
            vtAçmaTalebi.onupgradeneeded = function (olay) {
                let vt = olay.target.result;
                vt.onerror = function (olay) {console.log ("Veritabanýný yükleme hatasý.");};
                let nesneDeposu = vt.createObjectStore ('rushAlbümDosyasý', {keyPath: 'albümBaþlýðý'});
                nesneDeposu.createIndex ('yýl', 'yýl', {unique: false});
            }; // vtA.. sonu...

            function kayýtlarýEkle() {
                let iþlem = vt.transaction (['rushAlbümDosyasý'], "readwrite");
                let nesneDeposu = iþlem.objectStore ('rushAlbümDosyasý');
                for (i = 0; i < kayýtlar.length ; i++) {let talep = nesneDeposu.put (kayýtlar [i]);}
                iþlem.oncomplete = function() {kayýtlarýGöster();}
            } // func sonu...

            function kayýtlarýGöster() {
                listele.innerHTML = "";
                let iþlem = vt.transaction (['rushAlbümDosyasý'], 'readonly');
                 let nesneDeposu = iþlem.objectStore ('rushAlbümDosyasý');
                nesneDeposu.openCursor().onsuccess = function (olay) {
                    let imleç = olay.target.result;
                    if (imleç) {
                        let listeBirimi = document.createElement ('li');
                        listeBirimi.innerHTML = '<strong>' + imleç.value.albümBaþlýðý + '</strong>, ' + imleç.value.yýl;
                        listele.appendChild (listeBirimi);
                        //console.log (imleç.source);
                        //console.log (imleç.key);
                        //console.log (imleç.primaryKey);
                        //console.log (imleç.value);
                        imleç.continue();
                    }else {console.log ('Tüm kayýtlar gösterildi.');}
                }; // nes.. sonu...
            } // func sonu...

            hepsiniGör.onclick = function() {kayýtlarýGöster();}; // button class deðiþkenlere onclick fonksiyonlarý atanyor...
            atlayarakGör.onclick = function() {atlayarakGörelim();};
            kayýtSil.onclick = function() {kaydýSilelim();};
            tekKaydýDeðiþtir.onclick = function() {tekKaydýDeðiþtirelim();};
            tersSýrala.onclick = function() {tersten();}

            function atlayarakGörelim() {
                listele.innerHTML = "";
                let iþlem = vt.transaction (['rushAlbümDosyasý'], 'readonly');
                let nesneDeposu = iþlem.objectStore ('rushAlbümDosyasý');
                nesneDeposu.openCursor().onsuccess = function (olay) {
                    let imleç = olay.target.result;
                    if (imleç) {
                        let listeBirimi = document.createElement ('li');
                        listeBirimi.innerHTML = '<strong>' + imleç.value.albümBaþlýðý + '</strong>, ' + imleç.value.yýl;
                        listele.appendChild (listeBirimi);
                        imleç.advance (2); // continue() yerine...
                    }else {console.log ('Atlamalý kayýtlar gösterildi.');}
                }; // nes.. sonu...
            } // func sonu...

            function kaydýSilelim() {
                listele.innerHTML = "";
                let iþlem = vt.transaction (['rushAlbümDosyasý'], 'readwrite');
                let nesneDeposu = iþlem.objectStore ('rushAlbümDosyasý');
                nesneDeposu.openCursor().onsuccess = function (olay) {
                    let imleç = olay.target.result;
                    if (imleç) {
                        if (imleç.value.albümBaþlýðý === 'Grace under pressure') {
                            let talep = imleç.delete();
                            talep.onsuccess = function() {console.log ("1984'ün vasat albümü silindi. 'Power windows' albümü bile daha iyidir."); };
                        }else {
                            let listeBirimi = document.createElement ('li');
                            listeBirimi.innerHTML = '<strong>' + imleç.value.albümBaþlýðý + '</strong>, ' + imleç.value.yýl;
                            listele.appendChild (listeBirimi);   
                        } // else sonu...
                        imleç.continue();
                    }else {console.log ("Grace'siz listeleme tamamlandý");}
                }; // nes.. sonu...
            } // func sonu...

            function tekKaydýDeðiþtirelim() {
                listele.innerHTML = '';
                let iþlem = vt.transaction (['rushAlbümDosyasý'], 'readwrite');
                let nesneDeposu = iþlem.objectStore ('rushAlbümDosyasý');
                nesneDeposu.openCursor().onsuccess = function (olay) {
                    let imleç = olay.target.result;
                    if (imleç) {
                        if (imleç.value.albümBaþlýðý === 'A farewell to kings') {
                            let deðiþen = imleç.value;
                            deðiþen.yýl = 2050;
                            let talep = imleç.update (deðiþen); // imleç.key olarak günceller...
                            talep.onsuccess = function() {console.log ('Ütobik bir albüm yýlý?..'); };
                        } // iç-if sonu...
                        let listeBirimi = document.createElement ('li');
                        listeBirimi.innerHTML = '<strong>' + imleç.value.albümBaþlýðý + '</strong>, ' + imleç.value.yýl;
                        listele.appendChild (listeBirimi);
                        imleç.continue();
                    }else {console.log ('Güncel liste tamamlandý.'); }
                }; // nes.. sonu...
            } // func sonu...

            function tersten() {
                listele.innerHTML = "";
                let iþlem = vt.transaction (['rushAlbümDosyasý'], 'readonly');
                let nesneDeposu = iþlem.objectStore ('rushAlbümDosyasý');
                nesneDeposu.openCursor (null, 'prev').onsuccess = function (olay) {// "prev" sondan baþa okur...
                    let imleç = olay.target.result;
                    if (imleç) {
                        let listeBirimi = document.createElement ('li');
                        listeBirimi.innerHTML = '<strong>' + imleç.value.albümBaþlýðý + '</strong>, ' + imleç.value.yýl;
                        listele.appendChild (listeBirimi);
                        imleç.continue();
                    }else {console.log ('Kayýtlar tersten listelendi.');}
                }; // nes.. sonu...
            } // func sonu...
        }; // win.. sonu...
    </script>
</body>
</html>