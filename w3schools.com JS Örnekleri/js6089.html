<!DOCTYPE html>
<html>
<head>
    <meta charset="iso-8859-9 Türkçe" />
    <title>js6089.html: Seçilen disk dosyalarýný indexedDB vasýtasýyla saklama örneði.</title>
    <style>
        body {background-color:OliveDrab; color: Cyan; font-size:20px;}
        input {background-color:Navy; color:orange;}
        button {background-color: FireBrick; color: yellow; font-size:15px;}
        #göster {color:Yellow; font-size:18px;}

        html {
            padding: 0;
            margin: 0;}
        body {
            padding: 0 0 0 2em;
            margin: 0;}
        button {
            margin-right: 1em;
            box-shadow: 2px 5px 12px Purple;}
        #mesajlar {
            border: 5px solid #aaa;
            width: 30em;
            margin-top: 1em;
            padding: 0 1em;}
        #dosyaSeçici {
            display: none;
            width: 33em;}
    </style>
    <script>
        function fonk1() {document.getElementById ("göster").innerHTML ="";}
    </script>
</head>
<body>
    <input type="button" value="reload() ile Yenile" onClick="window.location.reload();"><br/>
    <!--<input type="button" value="Sil" onClick="fonk1()">-->
    <h4>indexedDB</h4>

    <h2>Seçilen Dosyalarý indexedDB ile Saklama</h2>
    <div>
        <button id="açDüðmesi">VT'ný Yarat/Aç</button>
        <!-- VT mevcutsa açar, yoksa yaratýr. -->
        <button id="ekleDükmesi">VT'na Ekle</button>
        <button id="gösterDüðmesi">VT'ný Göster</button>
        <!--<button id="kaydýSilDüðmesi">Bir Kaydý Sil</button>-->
        <button id="silDüðmesi">VT'ný Sil</button>
    </div>

    <div id="mesajlar">
        <p>Eðer VT/VeriTabaný mevcut deðilse, <strong>VT'ný Yarat/Aç</strong> týklandýðýnda yaratýr. Yok eðer mevcutsa onu (içerdiði kayýtlarla) açar.</p>
        <p>Programý ilk yükleyiþte, þayet yeni kayýt eklemek istiyorsanýz <strong>VT'na Ekle</strong> düðmesinden önce her halukarda <strong>VT'ný Yarat/Aç</strong> düðmesini týklamalýsýnýz.</p>
    </div>

    <p>
        <input type="file" id="dosyaSeçici" multiple size="24">
        <!-- Veri tabaný yaratýlmýþ/açýk ve sonrasý her göster düðmesine týklanýnca bu düðme görünecektir. -->
    </p>

    <div id="listelemeElemaný"></div>

    <p id="göster">Paragraf</p>

    <script>
        var globalVT = {}; // indexedDB ile alakalý tüm global deðiþkenler bu nesnede toplanacaktýr.
        globalVT.vt = null; // VT nesnesi burada depolanacaktýr.
        globalVT.açýklama = "Bu veritabaný seçilen dosyalarý lokal depolamaktadýr."; // VT'nýn açýklamasý.
        globalVT.VTadý = "Lokal dosya deposu"; // VT'nýn adý.
        globalVT.sürümü = 1; // Daima >= 1. Müþteriler açýsýndan, eþzamanlý çoklu kullanýlsa da ayný isimli veritabanýnýn ancak tek bir sürüm numarasý olabilir.
        globalVT.depoAdý = "depo nesnesi-1"; // Veritabanýndaki çoklu olabilen depo nesnesi kayýt dosyasý adý.
        globalVT.mesaj = ""; // Gerektiðinde görünen ve 1-2 satýrlýk bilgi içeren 'mesajlar' DIV kutusu mesajý.
        globalVT.boþMu = true; // Ýlk yaratýlýþta boþ olan ve VT'nin kayýt içerip içermediðini gösteren deðiþken.
// ---------------------------------------------------------------------------------------------------

        if (gerekliDestekÖzellikleri() ) {
            // Tarayýcýdaki 4 VT iþlemleriyle ilgili düðmeleri burada olay dinleyicisine duyarlayalým...
            document.getElementById ('açDüðmesi').addEventListener ('click', açVT, false);
            document.getElementById ('ekleDükmesi').addEventListener ('click', ekleVT, false);
            document.getElementById ('gösterDüðmesi').addEventListener ('click', gösterVT, false);
            //document.getElementById ('kaydýSilDüðmesi').addEventListener ('click', silKayýt, false);
            document.getElementById ('silDüðmesi').addEventListener ('click', silVT, false);

            // Ayrýca VT'na Ekle týklandýðýnda görünür kýlýnan dosyaSeçici düðmesini de dinleyiciye duyarlayalým...
            document.getElementById ('dosyaSeçici').addEventListener ('change', dosyaSeçilmesiniYönet, false);
        } // if sonu...

        function gerekliDestekÖzellikleri() {return true; // Esgeçelim...
            switch (window.location.protocol) {// Çalýþabilmesi için http.server'da yürütülmesidir...
                case "http:": break;
                case "https:": break;
                case "ms-wwa-web:": break;
                case "ms-wwa:": break;
                default:
                    document.getElementById ('listelemeElemaný').innerHTML = "<h4>indexedDB sayfalarý http:// veya https:// protokolunda çalýþtýrýlmaktadýr - bu sorunu halledip tekrar deneyin.</h4>";
                    return false;
            } // swi.. sonu...

            if (! document.getElementById ('dosyaSeçici').files) {
                document.getElementById ('listelemeElemaný').innerHTML = "<h3>Input 'file' tipi desteklenmiyor - tarayýcýnýzý güncelleyin.</h3>";
                return false;
            } // if sonu...

            if (! window.indexedDB) {
                if (window.mozIndexedDB) {window.indexedDB = window.mozIndexedDB;
                } else if (window.webkitIndexedDB) {
                        window.indexedDB = webkitIndexedDB;
                        IDBCursor = webkitIDBCursor;
                        IDBDatabaseException = webkitIDBDatabaseException;
                        IDBRequest = webkitIDBRequest;
                        IDBKeyRange = webkitIDBKeyRange;
                        IDBTransaction = webkitIDBTransaction;
                    } else {
                            document.getElementById ('listelemeElemaný').innerHTML = "<h3>Tarayýcýnýz indexedDB' desteklemiyor - güncelleyin.</h3>";
                            return false;
                        } // else sonu...
            } // if sonu...

            if (! window.indexedDB.deleteDatabase) {// VT silme metodu tüm tarayýcýlarcadesteklenmiyor, test etmeliyiz.
                document.getElementById ('listelemeElemaný').innerHTML = "<h3>Gerekli indexedDB sürümüne sahip deðilsiniz.</h3>";
                return false;
            } // if sonu...

            return true;
        } // func sonu...
// ---------------------------------------------------------------------------------------------------    

        function açVT() {
            console.log ("açVT()");
            mesajýGöster ("<p>Talebiniz sýraya konuldu.</p>"); // Normalen, bu mesaj anlýk bir sonrakiyle deðiþtirilecektir.

            if (! window.indexedDB.open) {
                console.log("açVT() fonksiyonunda window.indexedDB.open deðeri null'dur");
                return;
            } // if sonu...

            try {var açTalebi = window.indexedDB.open (globalVT.VTadý, globalVT.sürümü); // VT adý ve sürümü baþta verilmiþti...
                açTalebi.onerror = function (olay) {console.log ("açVT() içinde açTalebi.onerror HATA fýrlattý: " + (olay.target.error ? olay.target.error : olay.target.errorCode) ); }
                açTalebi.onblocked = açVT_bloklandý; // Veritabaný baþka bir iþlemle açýlmýþ olabilir.
                açTalebi.onupgradeneeded = açVT_güncellemeihtiyacý; // Ya veritabaný yok, yada çoklu kullaným gereði sürüm numarasý uyuþmuyor.
                açTalebi.onsuccess = açVT_baþarýlý; // Veritabaný verili sürüm numarasýyla açýlmýþtýr.        
            } catch (ist) {console.log ("açVT() içinde window.indexedDB.open ÝSTÝSNASI: " + ist.message); }
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function mesajýGöster (mesaj) {document.getElementById ('mesajlar').innerHTML = mesaj; }
// ---------------------------------------------------------------------------------------------------

        function açVT_bloklandý (olay) {
            console.log ("açVT_güncellemeihtiyacý() bloklanma HATASI");

            var mesaj = "<p>Veritabaný bloke edildi - HATA: " + (olay.target.error ? olay.target.error : olay.target.errorCode) + "</p>";
            mesaj += "</p>Eðer bu sayfa tarayýcýnýn diðer penceresinde de açýksa, onlar kapatýlmalý.</p>";
            mesajýGöster (mesaj);
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function açVT_güncellemeihtiyacý (olay) {
            console.log ("açVT_güncellemeihtiyacý()");
            mesajýGöster ("<p>Talebiniz sýraya konuldu.</p>"); // Anlýk mesaj geçiþi.

            var vt = globalVT.vt = olay.target.result; // Açýlan ve nesne deposu yaratýlacak olan veritabaný globale de atanýyor...
            if (! vt) {
                console.log ("açVT_güncellemeihtiyacý() içinde vt (yani, olay.target.result) null/hiçlik'tir.");
                return;
            } // if sonu...

            try {vt.createObjectStore (globalVT.depoAdý, {keyPath: "kimlik", autoIncrement: true});
                // Yukarda verili adla nesne deposu, otomatik artacak kimlik anahtarýyla yaratýlmaktadýr; böylece put'la ayný dosya farklý kimlik'le yüklenebilir.
            } catch (ist) {
                console.log ("açVT_güncellemeihtiyacý() içinde ÝSTÝSNA: " + ist.message);
                return;}

            globalVT.mesaj = "<p>Veritabaný ve nesne deposu yaratýlmýþtýr.</p>"; // Bu saklý global mesaj, onsuccess'de yansýtýlacaktýr.
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function açVT_baþarýlý (olay) {
            console.log ("açVT_baþarýlý()");
            mesajýGöster ("<p>Talebiniz sýraya konmuþtur.</p>"); // Spontane mesaj.

            var vt = globalVT.vt = olay.target.result;

            if (!vt) {
                console.log ("açVT_baþarýlý() içinde vt (yani, olay.target.result) null/hiçlik durumu.");
                return;
            } // if sonu...

            globalVT.mesaj += "<p>Veritabanýnýn açýlýþý baþarýlýdýr.</p>";
            mesajýGöster (globalVT.mesaj);
            globalVT.mesaj = ""; // Mesaj yansýtýlmýþtýr, içeriði temizlenebilir.
        } // açVTsuccess
// ---------------------------------------------------------------------------------------------------

        function ekleVT() {
            console.log ("ekleVT()");

            if (! globalVT.vt) {
                mesajýGöster ("<p>Veritabaný henüz yaratýlmadý/açýlmadý.</p>");
                console.log ("ekleVT() içinde vt (yani, globalVT.vt) null/hiç'tir.");
                return;
            } // if sonu...

            document.getElementById ('dosyaSeçici').style.display = "block";
            // Geçerli ev açýk veritabaný ve nesne deposu mevcut olduðuna göre artýk dosya eklemesi yapýlabilir.

            var mesaj = "<p>Alttaki <strong>Dosyalarý Seç</strong> düðmesini týklayarak, diskinizdeki herhangibir dosyayý seçip veritabaný kayýt dosyasýna ekleyebilirsiniz.</p>";
            mesaj += "<p>Bilahare <strong>VT'ný Göster</strong> düðmesiyle veritabaný deposundaki kayýtlý dosyalarýn listesini görebilirsiniz.</p>";
            mesajýGöster (mesaj);
    } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function gösterVT() {
            console.log ("gösterVT()");

            var vt = globalVT.vt;

            if (! vt) {
                mesajýGöster ("<p>Gösterilecek veritabaný yok.</p>");
                console.log ("gösterVT() içinde vt (yani, globalVT.vt) null/hiç'tir.");
                return;
            } // if sonu...

            try {var iþlem = vt.transaction (globalVT.depoAdý, (IDBTransaction.READ_ONLY ? IDBTransaction.READ_ONLY : 'readonly'));
                // Bu ifade baþarýlýdýr yada istisna fýrlatýr. Üçlü iþlemci sadece READ_ONLY okuma kipini destekleyen tarayýcýlar içindir.
            }catch (ist) {console.log ("gösterVT() içinde vt.transaction() ÝSTÝSNASI: " + ist.mesaj);
                return;}

            try {var nesneDeposu = iþlem.objectStore (globalVT.depoAdý);
                try {var imleçTalebi = nesneDeposu.openCursor();

                    imleçTalebi.onerror = function (olay) {console.log ("gösterVT() içinde imleçTalebi.onerror'un fýrlattýðý HATA: " + (olay.target.error ? olay.target.error : olay.target.errorCode) ); }

                    var htmlDosyalarListesi = "<p><strong>Veritabanýndaki dosya(lar): </strong></p><ul style='margin: -0.5em 0 1em -1em;'>";
                    // Dikkat edilirse, veritabaný boþsa (null) bu deðiþken hiç kullanýlmadan dönülecektir.

                    imleçTalebi.onsuccess = function (olay) {
                        console.log ("gösterVT() içinde imleçTalebi.onsuccess fýrlatýldý.");

                         var imleç = olay.target.result; // Nesne deposundan mevcut ilk nesne alýnýr.

                        if (imleç) {
                            globalVT.boþMu = false; // Buraya ulaþýldýðýnda veritabaný boþ deðil, yani enaz bir kayýt var demektir.
                            htmlDosyalarListesi += "<li>" + imleç.value.name;
                            htmlDosyalarListesi += "<p style='margin: 0 0 0 0.75em;'>" + imleç.value.lastModifiedDate + "</p>";
                            htmlDosyalarListesi += "<p style='margin: 0 0 0 0.75em;'>" + imleç.value.size + " byte</p>";
                            imleç.continue(); // Nesne deposundaki birsonraki kayda geçerek if içinde döngü yapar.
                        }else {
                            htmlDosyalarListesi += "</ul>";
                            mesajýGöster (htmlDosyalarListesi);
                        } // else sonu...

                        if (globalVT.boþMu) {mesajýGöster ("<p>Veritabaný boþtur &ndash; ve gösterilecek kayýt yoktur.</p>"); }
                   } // iml.. sonu...
                }catch (ist) {console.log ("gösterVT() içinde iç-try ÝSTÝSNASI: " + ist.message); }
            }catch (ist) {console.log ("gösterVT() içinde dýþ-try ÝSTÝSNASI: " + ist.message); }
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function silKayýt() {
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function silVT() {
            var cevap = prompt ("Tüm veri tabaný ve içerdiði depo ve kayýtlarý tamamen silinecek.\nEmin misin [e/h]: ", "h");
            if (cevap.toLowerCase() != "e") {return;}

            console.log ("silVT");
            mesajýGöster ("<p>Talebiniz sýraya konulmuþtur.</p>"); // Anlýk mesaj...

            try { // Eðer veritabaný açýksa, silinmeden önce kapatýlmalýdýr, yoksa biteviye bekletilir.
                if (globalVT.vt) {globalVT.vt.close();
                }else {return;} // Veritabaný yoksa, dönülür...

                var silmeTalebi = window.indexedDB.deleteDatabase (globalVT.VTadý);

                silmeTalebi.onerror = function (olay) {console.log ("silVT() içinde silmeTalebi.onerror HATASI: " + (olay.target.error ? olay.target.error : olay.target.errorCode) ); }

                silmeTalebi.onsuccess = function() {
                    globalVT.vt = null;
                    globalVT.boþMu = true;
                    globalVT.mesaj = "";
                    mesajýGöster("<p>Veritabaný, nesne depolarý ve içerilen tüm kayýtlarý silindi.</p><p>Veritabanýnýn çalýþmasý için programý reload/yenidenyükle'yin.</p>");
                } // sil.. sonu...
            }catch (ist) {console.log ("silVT() içinde fýrlatýlan ÝSTÝSNA: " + ist.mesaj);}
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        function dosyaSeçilmesiniYönet (olay) {
            console.log ("dosyaSeçilmesiniYönet()");

            var seçilenDosya_lar = olay.target.files; // Tek yada çoklu dosya seçilebilir...
            if (! seçilenDosya_lar) {
                mesajýGöster ("<p>Seçilen dosyalarýn enza biri hatalý - klasör seçilemez.</p><p>Lütfen yeniden seçin ve deneyin.</p>");
                return;
            } // if sonu...

            var vt = globalVT.vt;
            if (! vt) {console.log ("dosyaSeçilmesiniYönet() içinde vt (yani, globalVT.vt) null/hiç'tir."); return;}

            try {var iþlem = vt.transaction (globalVT.depoAdý, (IDBTransaction.READ_WRITE ? IDBTransaction.READ_WRITE : 'readwrite'));
            }catch (ist) {console.log ("dosyaSeçilmesiniYönet() içinde vt.transaction ÝSTÝSNASI: " + ist.message); return; }

            iþlem.onerror = function (olay) {console.log ("dosyaSeçilmesiniYönet() içinde iþlem.onerror'ýn fýrlattýðý HATA: " + (olay.target.error ? olay.target.error : olay.target.errorCode) ); }
            iþlem.onabort = function() {console.log ("dosyaSeçilmesiniYönet() içinde iþlem.onabort fýrlatýldý."); }
            iþlem.oncomplete = function() {console.log ("dosyaSeçilmesiniYönet() içinde iþlem.oncomplete fýrlatýldý."); }

            try {var nesneDeposu = iþlem.objectStore (globalVT.depoAdý); // Herbir iþlemde çoklu put()'lar olabilir.
                for (var i = 0, dosya; dosya = seçilenDosya_lar [i]; i++) {
                    var koyTalebi = nesneDeposu.put (dosya); // add() ayný anahtarlý 2.kaydý reddederken put() günceller.
                    koyTalebi.onsuccess = function() {globalVT.boþMu = false;} // Enaz bir kayýt varsa veritbaný artýk boþ deðildir.
                    koyTalebi.onerror = function (olay) {console.log ("dosyaSeçilmesiniYönet() içinde koyTalebi.onerror'ýn fýrlattýðý HATA: " + (olay.target.error ? olay.target.error : olay.target.errorCode) ); }
                } // for sonu...
            }catch (ist) {console.log ("dosyaSeçilmesiniYönet() içinde put() ÝSTÝSNASI: " + ist.message); return;}

            document.getElementById ('dosyaSeçici').style.display = "none"; // Dosya seçimi sonrasý yeni ekleVT týklanýncaya dek seçici gizlenir.
        } // func sonu...
// ---------------------------------------------------------------------------------------------------

        document.getElementById ("göster").innerHTML =""
    </script>
</body>
</html>

<!--Not: Bu program "gerekliDestekÖzellikleri(){return true;" ilk "return true; ifadesi iptal edilirse, http protokolünde çalýþtýrýlmalýdýr:
>python -m http.server
komutlu
http://localhost:8000/js6089.html
yurel adresiyle çalýþmaktadýr...
-->