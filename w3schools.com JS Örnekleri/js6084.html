<!DOCTYPE html>
<html>
<head>
    <meta charset="iso-8859-9 Türkçe" />
    <title>js6084.html: IndexedDB örneði.</title>
    <style>
        body {background-color:OliveDrab; color: Cyan; font-size:20px;}
        input {background-color:Navy; color:orange;}
        button {background-color: FireBrick; color: yellow; font-size:15px;}
        #göster {color:Yellow; font-size:18px;}

    </style>
    <script>
        function fonk1() {document.getElementById ("göster").innerHTML ="";}
    </script>
</head>
<body>
    <input type="button" value="reload() ile Yenile" onClick="window.location.reload();"><br/>
    <input type="button" value="Sil" onClick="fonk1()">
    <h4>IndexedDB</h4>
    <p id="göster">Paragraf</p>

    <input type="button" value="Veritabanýný aç" onClick="fonk2()">
    <input type="button" value="SÝL" onClick="fonk3()"><br>
    <input type="button" value="Kayýt dosyasýný yarat" onClick="fonk4()">
    <input type="button" value="SÝL" onClick="fonk5()"><br>
    <input type="button" value="Kayýt Ekle" onClick="fonk6()"><br><br>
    <a href="js6084x1.html" target="_">(idb-await-promise örneði) Týkla ve çalýþtýr</a>

    <script>
        let açýþTalebi;
        let vt;
        let dosyaAdý = "Kitaplar";
        let kitapAdý;
        function fonk2() {
            let vtAdý = prompt ("Veri tabaný adýný girin:", "mny1");
            let sürümü = prompt ("Sürüm no:", "2");
            açýþTalebi = indexedDB.open (vtAdý, sürümü);

            açýþTalebi.onerror = function() {console.error ("HATA: " + açýþTalebi.error); };

            açýþTalebi.onupgradeneeded = function() {
                // Mevcut veritabaný sürümü 2'den küçük veya mevcut deðil...
                console.log ("Güncelleme gerekiyor...");
                vt = açýþTalebi.result;
                switch (vt.version) {// mevcut vt/veriTabaný sürüm tamsayý no'su...
                    case 0:
                        console.log ("Sürüm=0, müþterinin veritabaný yok, yeniden baþlat...");
                        break;
                    case 1: console.log ("Sürüm=1, güncelle...");
                } // swi sonu...
            }; // açýþ sonu...

            açýþTalebi.onsuccess = function() {
                vt = açýþTalebi.result;
                console.log ("Veritabaný açýlýþý baþarýlý: " + vt);
                vt.onversionchange = function() {
                    vt.close();
                    alert ("Veritabaný sürümü eski.\nLütfen sayfayý yeniden yükleyip sürüm=2'yle yeniden açýn!");
                }; // vt sonu...
            }; // açýþ sonu...
        } // func sonu...
        function fonk3() {
            let ad = prompt ("Silinecek veri tabaný adýný girin:", "mny1");
            let silmeTalebi= indexedDB.deleteDatabase (ad);
            silmeTalebi.onerror = function() {console.error ("HATA: " + silmeTalebi.error); };
            silmeTalebi.onsuccess = function() {
                let vtSil = silmeTalebi.result;
                console.log ("Veritabaný silinmiþtir: " + vtSil); };
        } // func sonu...
        function fonk4() {
            dosyaAdý = prompt ("Veritabanýnda kayýtlarýn ekleneceði dosya adýný girin:", "kitaplar");
            açýþTalebi.onupgradeneeded = function() {
                vt = açýþTalebi.result;
                if (! vt.objectStoreNames.contains (dosyaAdý)) { // Eðer veritabanýnda kitaplar dosyasý yoksa...
                    vt.createObjectStore (dosyaAdý, {keyPath: 'kitapAdý'}); // Anahtar kitapAdý olacak...
                } // if sonu...
            } // açýþ sonu...
        } // func sonu...
        function fonk5() {
            dosyaAdý = prompt ("Veritabanýnda silinecek dosya adýný girin:", "kitaplar");
            açýþTalebi.onupgradeneeded = function() {
                vt = açýþTalebi.result;
                vt.deleteObjectStore (dosyaAdý);
            } // açýþ sonu...
        } // func sonu...
        function fonk6() {
            let iþlem = vt.transaction (dosyaAdý, "readwrite");
            let kitaplar = iþlem.objectStore (dosyaAdý);
            let kitap = {
                kitapAdý: prompt ("Kitap adýný girin:", "JavaScript"),
                fiyatý: prompt ("Fiyatýný girin: TL", "10"),
                tarih: new Date()
            }; // kit sonu...
            let talep = kitaplar.add (kitap);

            talep.onsuccess = function() {console.log ("Kitap kaydý dosyaya eklendi", talep.result); };
            talep.onerror = function() {console.log ("HATA", talep.error); };
        } // func sonu...

        document.getElementById ("göster").innerHTML =
            "1) indexedDB tarayýcýnýn localStorage'dan daha güçlü ve güvenilir bir indisli veritabaný \
            olanaðý olup tekli/çoklu anahtar kabul eder, endeksli ve taranabilirdir, daha çok \
            anahtar-deðer çifti saklayabilir, çevrim-dýþý iþlem yapar. Olay-tabanlý/event-based ve \
            ayrýca da  sarmal-tabanlý/wrapper-based'dýr." +
            "<br>2) Öncelikle veritabaný açýþ talebinde bulunulur." +
            "<br>let açýþTalebi = indexedDB.open(ad, sürümNo);" +
            "<br>Ad, veritabanýnýn adýdýr; pozitif tamsayý olan varsayýlý sürümNo=1'dir. Açýþ talebi \
            sonrasý olaylar dinlenir: açýþTalebi.onupgradeneeded olayý, veritabanýnýn hazýr \
            olduðunu, ancak güncelleme gerektirdiði belirtilir; açýþTalebi.onerror olayý, hata \
            bildirir, veritabaný açýlýþý baþarýsýzdýr; açýþTalebi.onsuccess olayýysa veritabanýnýn \
            açýk ve hazýr olduðunu bildirir." +
            "<br>==>Alttaki düðmelerle bir veritabaný açabilir veya silebilirsiniz:" +
            "<br>3) Ayný veritabanýnýn paralel sekmelerdeki kullanýmlarýnda sürüm farklýlýðý oluþursa," +
            "<br>vt.onversionchange = function(){vt.close();} ile veri tabanýný (icabýnda alert ikazlý) \
            kapar, yeni sürümle açarak olasý program çökme hatalarýný yönetebiliriz." +
            "<br>4) Veritabaný açýldýktan sonra, kayýtlarýn girileceði dosya adý ve anahtarý onupgradeneeded \
            olayýnda createObjectStore ile (önceden tanýmlanmamýþsa) tanýmlanýr." +
            "<br>if (!vt.objectStoreNames.contains (dosyaAdý)){vt.createObjectStore (dosyaAdý, {keyPath: 'kitapAdý'}) }" +
            "<br>Nesne depolarýnýn yaratma/silme/deðiþtirme iþlemleri ancak onupgradeneeded \
            fonksiyonu içinde, tek tek kayýtlarýn ekleme/silme/güncelleme iþlemleri ise haricen yapýlabilir." +
            "<br>5) Mevcut açýk veritabanýndaki nesne deposu kayýt dosyasýna kayýtlar add veya put ile yapýlabilir." +
            "<br>vt.transaction(dosyaAdý,'readwrite').objectStore(dosyaAdý).add(kayýtAdý)/.put(kayýtAdý)" +
            "<br>ile kayýtlar dosyaya kayýtanahtarý/kitapAdý anahtarýyla eklenir; önceden ayný \
            kayýt girilmiþse add hata verir, put ise önceki içeriði deðiþtirir." +
            "<br>6) Kayýt ekleme transaction iþleminin tamamlandýðýný transaction.oncomplete \
            olayýyla test edebiliriz. Kayýt ekleme deðiþikliklerini yapýlmadan, anlýk terketmek için \
            transaction.abort() girebiliriz. Program sonlanmasý veya fetch gibi makro görevler \
            iþlemi tamamlayarak bitirir." +
            "<br>7) Kayýt ekleme hatasý, iþlemi abort/terkeder. Olayý yönetip, örn.yeni kayýtanahtarý denemek istersek:" +
            "<br>talep.onerror=function(olay){if (talep.error.name=='ConstraintError') {olay.preventDefault();}}" +
            "<br>hata yönetimiyle yeni bir anahtarla kayýt eklemeyi tekrarlayabiliriz." +
            "<br>8) Bir nesne deposundaki kayýtlar birkaç yöntemle eriþilebilir:" +
            "<br>==>dosyaAdý.get('js'); // Mevcutsa tek kaydý döndürür." +
            "<br>==>dosyaAdý.getAll(IDBKeyRange.bound('css', 'html')); // css ve html arasýndakileri döndürür." +
            "<br>==>dosyaAdý.getAll(IDBKeyRange.lowerBound('html', true)); // html ve sonralarýný döndürür." +
            "<br>==>dosyaAdý.getAll(); // Dosyada mevcut tüm kayýtlarý döndürür." +
            "<br>==>books.getAllKeys(IDBKeyRange.lowerBound('js', true)); // js ve sonraki anahtarlarý döndürür." +
            "<br>9) Kayýtlar dosyada kitapAdý anahtarýyla versayýlý artan sýralý eriþilebildiði \
            gibi, ayrýca kitap fiyatý'na göre fiyatý:kitapAdý ikinci endeksi de yaratýlýr ve istenilen \
            fiyatý endeksli kitapAdý'larýna eriþilebilir:" +
            "<br>==>openRequest.onupgradeneeded=function() {\
            let kitaplar=db.createObjectStore('kitaplar', {keyPath: 'kitapAdý'});\
            let endeks=inventory.createIndex('fiyatEndeksi', 'fiyatý'); };" +
            "<br>==>let endeks=vt.transaction('kitaplar').transaction.objectStore('kitaplar').index('fiyatEndeksi');"+
            "<br>==>let talep=endeks.getAll(10);\
            talep.onsuccess = function() {\
                if (talep.result !== undefined) {console.log('Kitaplar', talep.result);\
                } else {console.log('Aranan kriterli kitaplar bulunamadý!..');} };" +
            "<br>==>let request = endeks.getAll(IDBKeyRange.upperBound(5));" +
            "<br>10) Kayýtlar, arama kriteriyle kitaplar'da kitapAdý veya endeks'te fiyatý ile eriþilip silinebilir:" +
            "<br>==>kitaplar.delete('js');" +
            "<br>==>let talep = endeks.getKey(5);\
            talep.onsuccess = function() {\
                let ad = talep.result;\
                let silTalebi = kitaplar.delete(ad); };" +
            "<br>==>kitaplar.clear(); // Tüm kayýtlarý siler..." +
            "<br>11) dosyaAdý.getAll() dizisi ile þayet kayýt fazlalýðýndan hafýza yetersiz kalýrsa \
            cursor/imleç kullanýlýr. Ýmleç þarta uygun kayýtlarý tümden dizi olarak deðil, ardýþýk tek-tek \
            next/sonraki-varsayýlý, prev/önceki, nextunique/sonrakiYegane ve prevunique/öncekiYegane \
           hafýzaya alýr. Örneklersek:" +
            "<br>==>let talep = vt.transaction('kitaplar').objectStore('kitaplar').openCursor();\
            talep.onsuccess = function() {// Þarta uyan tüm kayýtlar için tekrarlanýr...\
                let imleç = talep.result;\
                if (imleç) {\
                    let anahtar = imleç.key;\
                    let deðer = imleç.value;\
                    console.log(anahtar, deðer);\
                    imleç.continue();\
                } else {console.log('Baþka kitap kalmadý!..');} };" +
            "<br>==>imleç.advance(sayý) metodu sayý kadar ileriye atlar; imleç.continue([anahtar]) \
            metodu da ilk anahtar'a kadar atlar." +
            "<br>==>Ýmleç, depo anahtarý için olduðu gibi endeks için de çalýþýr. Örneðin: " +
            "<br>==>let talep = endeks.openCursor(IDBKeyRange.upperBound(5));\
            talep.onsuccess = function() {// Herbir kayýt için tekrarlar...\
                let imleç = talep.result;\
                if (imleç) {\
                    let anahtar = imleç.primaryKey; // sonraki depo nesne anahtarý (kitapAdý)\
                    let deðer = imleç.value;\
                    let anahtar = imleç.anahtar; // sonraki endeks anahtarý (fiyatý)\
                    console.log(anahtar, deðer);\
                    imleç.continue();\
                } else {console.log('Baþka kayýt kalmadý!..');} };" +
            "<br>12) Herbir talebe onsuccess/onerror eklemek yorucu denilirse, olay-tabanlý \
            yerine ambalaj-tabanlý idb await/beklemede promise/vaat kullanýlýr." +
            "<br>src='https://cdn.jsdelivr.net/npm/idb@3.0.2/build/idb.min.js" +
            "<br>script'te çevrimiçi kaynak gösterilerek yada indirilip src='idb.js' þeklinde \
            script'e gömerek çevrimdýþý indeksDB ambalajý olarak kullanýlabilir. Örneðin:" +
            "<br>==>let vt = await idb.openDb('mny1', 1, vt => {if (vt.oldVersion == 0) {vt.createObjectStore('kitaplar', {keyPath: 'kitapAdý'});}});\
            let iþlem = vt.transaction('kitaplar', 'readwrite');\
            let kitaplar = iþlem.objectStore('kitaplar');\
            try {await kitaplar.add(...); await kitaplar.add(...); await iþlem.complete; console.log('kitaplar saklandý');\
            } catch(hata) {console.log('HATA:', hata.message);}" +
            "<br>==>Örn.Alttaki link'le kitap ekleme idb-await-promise ambalaj-tabanlý programý deneyebilirsiniz:"
    </script>
</body>
</html>